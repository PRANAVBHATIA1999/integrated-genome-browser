<!--                                                                 -->
<!-- Test file for new, improved build system.  There are still a    -->
<!-- number of problems to be worked out.  This files does not yet   -->
<!-- have test, demo, or run targets. The test and demo targets may  -->
<!-- have to be one off, or the targets need to be added to all sub- -->
<!-- projects via the common.xml.  The common.xml should also be     -->
<!-- be able to be used on a sub-project alone.                      -->
<!--                                                                 -->
<project name="master" basedir=".">
	<target name="init">

		<!-- Locations of subprojets -->
		<property name="genoviz"       value="${basedir}/genoviz_sdk" />
		<property name="genometry"     value="${basedir}/genometry" />
		<property name="genometryImpl" value="${basedir}/genometryImpl" />
		<property name="igb"           value="${basedir}/igb" />
		<property name="das2server"    value="${basedir}/das2_server" />

		<!-- directory paths -->
		<property name="lib.dir"      value="${basedir}/ext" />
		<property name="demos.dir"    value="${genoviz}/demo" />
		<property name="tutorial.dir" value="${genoviz}/tutorial" />
		<property name="dist.dir"     value="${basedir}/dist" />
		<property name="docs.dir"     value="${basedir}/documentation/api-docs" />
		<property name="webstart.dir" value="${dist.dir}/webstart" />
		<property name="webapp.dir"   value="${dist.dir}/webapp" />

		<!-- global compiler defaults -->
		<property name="build.compiler"         value="modern" />
		<property name="ant.build.javac.target" value="5" />
		<property name="ant.build.javac.source" value="5" />

		<!-- compiler defaults passed to javac -->
		<property name="debug"         value="on" />
		<property name="deprecation"   value="off"/>
		<property name="compiler.args" value="-Xlint:none" />

		<!-- signjar defaults -->
		<property name="jar.sign.keystore"      value="${user.home}/.keystore" />
		<property name="jar.sign.keystore.pass" value="changeit" />
		<property name="jar.sign.alias"         value="igb" />
		<property name="jar.sign.alias.pass"    value="${jar.sign.keystore.pass}" />

		<!-- javadoc defaults -->
		<property name="javadoc.j2se.url"    value="http://java.sun.com/j2se/1.5.0/docs/api/" />
		<property name="javadoc.j2ee.url"    value="http://java.sun.com/javaee/5/docs/api/" />
		<property name="javadoc.src.version" value="5" />
		<property name="javadoc.src.path"   value="${genoviz}/src:${genometry}/src:${genometryImpl}/src:${igb}/src:${das2server}/src" />
	</target>


	<target name="compile" depends="init" description="Compile all genoviz subprojects">
		<iterate target="compile" />
	</target>

	<target name="demos" depends="jar" description="Compile genoviz demos">
    <javac debug="${debug}" deprecation="${deprecation}" includeAntRuntime="false">
			<src path="${demos.dir}" />
			<src path="${tutorial.dir}" />
			<classpath path="${genoviz}/build" />
			<compilerarg compiler="modern" value="${compiler.args}" />
    </javac>
		<copy file="${dist.dir}/genoviz.jar" todir="${genoviz}" />
	</target>

	<target name="compile-tests" depends="init">
		<iterate target="compile-tests" />
	</target>

	<target name="report-tests" depends="init">
		<iterate target="report-tests" />
	</target>

	<target name="jar" depends="init" description="Create jar files for all genoviz subprojects">
		<iterate target="jar" />
	</target>

	<target name="webstart" depends="init" description="Create webstart-compatible IGB jars">
		<iterate target="webstart" />

		<signjar destDir="${webstart.dir}" alias="${jar.sign.alias}" storepass="${jar.sign.keystore.pass}" keystore="${jar.sign.keystore}" keypass="${jar.sign.alias.pass}">
			<fileset dir="${lib.dir}">
				<exclude name="commons-codec-1.3.jar" />
				<exclude name="javax.servlet.jar" />
				<exclude name="org.mortbay.jetty.jar" />
				<exclude name="junit-4.5.jar" />
				<include name="*.jar" />
			</fileset>
		</signjar>

		<jar jarfile="${webstart.dir}/igb.jar" index="true">
			<zipfileset src="${dist.dir}/igb.jar" />
			<indexjars>
				<fileset dir="${webstart.dir}">
					<exclude name="igb.jar" />
					<include name="*.jar" />
				</fileset>
			</indexjars>
		</jar>

		<signjar jar="${webstart.dir}/igb.jar" alias="${jar.sign.alias}" storepass="${jar.sign.keystore.pass}" keystore="${jar.sign.keystore}" keypass="${jar.sign.alias.pass}" />
	</target>

	<target name="webapp" depends="jar" description="Create das2servlet web application">
		<mkdir dir="${webapp.dir}/WEB-INF/lib" />
		<copy todir="${webapp.dir}/WEB-INF/lib">
			<fileset dir="${dist.dir}">
				<include name="*.jar" />
			</fileset>
			<fileset dir="${lib.dir}">
				<include name="xercesImpl.jar" />
			</fileset>
		</copy>
		<copy file="${das2server}/web.xml" todir="${webapp.dir}/WEB-INF" />
	</target>

	<target name="all" depends="exe" description="Runs the 'jar' and 'exe' tasks">
		<iterate target="all" />
	</target>

	<target name="clean" depends="init">
		<delete file="igb_exe.jar"/>
		<delete file="${genoviz}/genoviz.jar" />
		<delete dir="${dist.dir}" />
		<delete dir="${webstart.dir}" />
		<delete dir="${webapp.dir}" />

		<delete>
			<fileset dir="${demos.dir}">
				<include name="**/*.class" />
			</fileset>
			<fileset dir="${tutorial.dir}">
				<include name="**/*.class" />
			</fileset>
		</delete>

		<iterate target="clean" />
	</target>

	<target name="docs" depends="init" description="Create java documentation for all genoviz subprojects">
		<mkdir dir="${docs.dir}"/>
		<javadoc destdir="${docs.dir}" author="true" version="true" use="true" windowtitle="Integrated Genome Browser API" maxmemory="128m" access="private" verbose="false" splitindex="false" source="${javadoc.src.version}">
			<sourcepath path="${javadoc.src.path}" />
			<classpath>
				<fileset dir="${lib.dir}" includes="*.jar" />
			</classpath>
			<link href="${javadoc.j2se.url}"/>
			<link href="${javadoc.j2ee.url}"/>
			<doctitle><![CDATA[<h1>IGB - Integrated Genome Browser</h1>]]></doctitle>
			<bottom><![CDATA[<i>Copyright &#169; Affymetrix, Inc.</i>]]></bottom>
		</javadoc>
	</target>

	<target name="exe" depends="jar" description="Create a single-jar IGB application">
		<jar jarfile="igb_exe.jar" update="false">
			<manifest>
				<attribute name="Main-Class" value="com.affymetrix.igb.IGB"/>
			</manifest>
			<metainf file="LICENSE.html"/>
			<metainf file="NOTICES.txt"/>
			<zipgroupfileset dir="${dist.dir}">
				<exclude name="das2server.jar" />
				<include name="*.jar"/>
			</zipgroupfileset>
			<zipgroupfileset dir="ext">
				<include name="*.jar"/>
			</zipgroupfileset>
		</jar>
	</target>

	<!--                                                                 -->
	<!-- Macro to pass targets to each sub project.  All sub projects    -->
	<!-- are build using common.xml.                                     -->
	<!--                                                                 -->
	<macrodef name="iterate">
		<attribute name="target" default=""/>
		<sequential>
			<subant target="@{target}" genericantfile="common.xml" inheritall="true">
				<!-- multiple dirsets ensure dependency ordering -->
				<dirset dir="${basedir}">
					<include name="genoviz_sdk" />
					<include name="genometry" />
				</dirset>
				<dirset dir="${basedir}">
					<include name="genometryImpl" />
				</dirset>
				<dirset dir="${basedir}">
					<include name="igb" />
				</dirset>
				<dirset dir="${basedir}">
					<include name="das2_server" />
				</dirset>
			</subant>
		</sequential>
	</macrodef>
</project>
